/*
WebCV: Blazingly fast computer vision in the browser

The MIT License (MIT)
Copyright (c) 2016 Nathan Soufflet <nathsou.fr@gmail.com>

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/
var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wcv;!function(t){function e(t){var r;if("string"!=typeof t||isNaN(r=parseFloat(t))||(t=r),"number"==typeof t)return t%1!==0?t.toString():t.toString()+".0";if(t instanceof Array){var n="",i=t.length-1;return t.forEach(function(t,r){n+=e(t)+(r!==i?", ":"")}),n}return t.toString()}!function(t){t[t["void"]=0]="void",t[t["float"]=1]="float",t[t.string=2]="string",t[t.vec2=3]="vec2",t[t.vec3=4]="vec3",t[t.vec4=5]="vec4",t[t.sampler2D=6]="sampler2D",t[t.bool=7]="bool",t[t["int"]=8]="int",t[t.mat2=9]="mat2",t[t.mat3=10]="mat3",t[t.mat4=11]="mat4"}(t.varType||(t.varType={}));var r=t.varType;!function(t){t[t.fragment=35632]="fragment",t[t.vertex=35633]="vertex"}(t.shaderType||(t.shaderType={}));var n=t.shaderType;t.throwError=function(t,e){if(console.warn("WCV : "+t),e)throw t};var i=0;t.vectorType=function(t){var e;return e=1===t.size?"float":"vec"+t.size};var s=function(t,e,r){if(t instanceof Uint8ClampedArray||(t=new Uint8ClampedArray(t)),ImageData)return new ImageData(t,e,r);for(var n=document.createElement("canvas"),i=n.getContext("2d"),s=i.createImageData(e,r),o=0;o<t.length;o++)s.data[o]=t[o];return s},o=function(){function t(t){if(this.callacks=[],this.name="u_image_"+i++,t instanceof HTMLImageElement){this.img=t,this.onload(function(){this.width=t.width,this.height=t.height},this);var e=this;this.img.onload=function(){for(var t=0,r=e.callacks;t<r.length;t++){var n=r[t];n.callback.call(n.thisArg)}e.callacks=[]}}else this.img=document.querySelector(t)}return t.prototype.loaded=function(){return this.img?this.img.complete:!0},t.prototype.toString=function(){return this.name},t.prototype.onload=function(t,e){this.loaded()?t.call(e||this):this.callacks.push({callback:t,thisArg:e||this})},t.prototype.at=function(t){return new A(["texture2D("+this.name+", "+t+")"])},t.prototype.destroy=function(t){t.deleteTexture(this.id),this.id=null},t}();t.Texture=o;var a=function(){function t(t){this.children=[],this.funcs=[],this.header=[],this.footer=[],this.lines=[],this.parent=t}return t.prototype.append=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];for(var r=0;r<t.length;r++){var n=t[r],i=n.charAt(n.length-1);";"!==i&&"}"!==i&&"{"!==i&&(n+=";"),this.lines.push(n)}return this.lines.length-1},t.prototype.top=function(t){var e=t.charAt(t.length-1);return";"!==e&&"}"!==e&&(t+=";"),this.header.unshift(t),0},t.prototype.prepend=function(t){var e=t.charAt(t.length-1);return";"!==e&&"}"!==e&&(t+=";"),this.header.push(t),this.header.length-1},t.prototype.hasFunc=function(t){for(var e=0,r=this.funcs;e<r.length;e++){var n=r[e];if(n.name===t)return!0}return!1},t.prototype.addChild=function(t){t instanceof h?this.funcs.push(t):this.children.push(t)},t.prototype.addChildren=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];for(var r=0;r<t.length;r++){var n=t[r];this.addChild(n)}},t.prototype.getCode=function(){for(var t="",e=0,r=this.header;e<r.length;e++){var n=r[e];t+=n+"\n"}for(var i=0,s=this.lines;i<s.length;i++){var n=s[i];t+=n+"\n"}for(var o=0,a=this.children;o<a.length;o++){var h=a[o];t+=h.getCode()+"\n"}this.funcs.sort(function(t,e){return e.precedence-t.precedence});for(var l=0,c=this.funcs;l<c.length;l++){var u=c[l];t+=u.getCode()+"\n"}for(var p=0,g=this.footer;p<g.length;p++){var n=g[p];t+=n+"\n"}return t},t}(),h=function(t){function e(e,r,n,i){t.call(this,i||null),this.params="",this.precedence=0,this.name=e,this.returnType=r,n&&(this.params=n)}return __extends(e,t),e.prototype.getCode=function(){return r[this.returnType]+" "+this.name+"("+this.params+"){"+t.prototype.getCode.call(this)+"}"},e}(a);t.Func=h;var l=function(e){function n(t,n){e.call(this,null),this.externals=[],this.type=t,n&&(this.lines=n),this.main=new h("main",r["void"],"",this)}return __extends(n,e),n.prototype.addFunction=function(t){this.hasFunc(t.name)||this.addChild(t)},n.prototype.addFunctions=function(t){for(var e=0;e<t.length;e++){var r=t[e];this.addFunction(r)}},n.prototype.compile=function(e){return this.webglShader=e.createShader(this.type),e.shaderSource(this.webglShader,this.getCode()),e.compileShader(this.webglShader),e.getShaderParameter(this.webglShader,e.COMPILE_STATUS)||(t.throwError("Shader compilation exception"),console.log(e.getShaderInfoLog(this.webglShader))),this.webglShader},n.prototype.destroy=function(t){t.deleteShader(this.webglShader),this.webglShader=null},n.prototype.f=function(t){for(var e=0,r=this.children;e<r.length;e++){var n=r[e];if(n instanceof h&&n.name===t)return n}},n.prototype.declareExternals=function(t){for(var e=0,r=this.externals;e<r.length;e++){var n=r[e];n.declare(this)}},n.prototype.addExternal=function(t){t.declared||(this.externals.push(t),t.declared=!0)},n.prototype.linkExternals=function(t){for(var e=0,r=this.externals;e<r.length;e++){var n=r[e];n.link(t)}},n.prototype.getCode=function(){return e.prototype.getCode.call(this)+this.main.getCode()+"\n"},n}(a),c=function(t){function e(e){void 0===e&&(e=[]),t.call(this,n.vertex,e),this.positionSet=!1,this.a_position=new x(r.vec2,"a_position"),this.a_position.declare(this),this.position=new A(["vec4("+this.a_position+", 0.0, 1.0)"]),this.position.name="position",this.position.declare(this.main)}return __extends(e,t),e.prototype.getCode=function(){return this.positionSet||(this.main.append("gl_Position = "+this.position),this.positionSet=!0),t.prototype.getCode.call(this)},e}(l);t.VertexShader=c,function(t){t[t.highp=0]="highp",t[t.mediump=1]="mediump",t[t.lowp=2]="lowp"}(t.precisionType||(t.precisionType={}));var u=t.precisionType,p=function(t){function e(e){void 0===e&&(e=[]),t.call(this,n.fragment,e),this.colorSet=!1,this.hasTexture=!1,this.precision=[],this.fragColor=new A([1]),this.fragColor.name="fragColor",this.fragColor.declare(this.main),this.texCoord=new T(r.vec2,"v_texCoord"),this.addExternal(this.texCoord),this.main.footer.push("gl_FragColor = "+this.fragColor+";")}return __extends(e,t),e.prototype.setPrecision=function(t,e){this.precision.push("precision "+u[e]+" "+r[t]+";\n")},e.prototype.getCode=function(){return this.colorSet||(this.colorSet=!0),this.precision.join("")+t.prototype.getCode.call(this)},e}(l);t.FragmentShader=p;var g=function(){function e(e,r){if(this.compiled=!1,this.textures=[],"string"==typeof e){var n=document.getElementById(e);n instanceof HTMLCanvasElement?this.canvas=n:t.throwError("HTMLCanvasElement '#"+n+"' not found")}else e instanceof HTMLCanvasElement?this.canvas=e:t.throwError("'canvas' argument must me an instance of HTMLCanvasElement or a string");this.gl=this.canvas.getContext("webgl",{preserveDrawingBuffer:!0})||this.canvas.getContext("webgl-experiment",{preserveDrawingBuffer:!0}),this.shaders=r}return e.prototype.addTexture=function(t){this.textures.push(t);var e=new y(r.sampler2D,t.name);if(this.shaders.fragment.addExternal(e),!this.shaders.fragment.hasTexture){var n=new T(r.vec2,"v_texCoord");this.shaders.vertex.addExternal(n),this.shaders.vertex.main.append(n+" = "+this.shaders.vertex.a_position+".st * vec2(0.5, -0.5) + 0.5"),this.shaders.fragment.fragColor.val("texture2D("+t+", v_texCoord)"),this.shaders.fragment.hasTexture=!0,console.log(this.gl),t.id=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,t.id),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.img)}},e.prototype.compile=function(){this.shaders.vertex.declareExternals(this),this.shaders.fragment.declareExternals(this),console.log(this.shaders.vertex.getCode()),console.log(this.shaders.fragment.getCode()),this.webglProgram=this.gl.createProgram(),this.gl.attachShader(this.webglProgram,this.shaders.vertex.compile(this.gl)),this.gl.attachShader(this.webglProgram,this.shaders.fragment.compile(this.gl)),this.gl.linkProgram(this.webglProgram),this.gl.getProgramParameter(this.webglProgram,this.gl.LINK_STATUS)||t.throwError("Unable to initialize the shader program."),this.gl.useProgram(this.webglProgram),this.shaders.vertex.linkExternals(this),this.shaders.fragment.linkExternals(this),this.compiled=!0},e.prototype.render=function(){if(this.compiled){var t=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,t),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),this.gl.STATIC_DRAW);var e=this.shaders.vertex.a_position.location;this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,2,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}},e.prototype.destroy=function(){this.gl.deleteProgram(this.webglProgram),this.webglProgram=null},e}();t.Prog=g,t.JS2=e;var f=function(){function n(t,e){this.str="",this.declared=!1,this.isConst=!1,this.type=r[t],this.name=e||this.type+"_"+n.count++}return n.prototype.toString=function(){return this.str},n.prototype.declare=function(t){this.block=t;var e=(this.isConst?"const ":"")+this.type+" "+this.name;e+=""===this.str?";":" = "+this.str,this.lineNb=this.block.prepend(e),this.declared=!0,this.str=this.name},n.prototype.val=function(e){this.block||t.throwError("Cannot change value, you may not have declared the variable.")},n.prototype.set=function(t){return"string"==typeof t&&(t=e(t)),this.str=t.toString(),this.declared&&this.block&&this.block.append(this.name+" = "+this.str),this},n.prototype.equ=function(t){return"string"==typeof t&&(t=e(t)),this.str+=" == "+t,this},n.prototype.neq=function(t){return"string"==typeof t&&(t=e(t)),this.str+=" != "+t,this},n.prototype.lss=function(t){return"string"==typeof t&&(t=e(t)),this.str+=" < "+t,this},n.prototype.leq=function(t){return"string"==typeof t&&(t=e(t)),this.str+=" <= "+t,this},n.prototype.gtr=function(t){return"string"==typeof t&&(t=e(t)),this.str+=" > "+t,this},n.prototype.geq=function(t){return"string"==typeof t&&(t=e(t)),this.str+=" >= "+t,this},n.prototype.add=function(t){return"string"==typeof t&&(t=e(t)),this.str+=" + "+t,this},n.prototype.sub=function(t){return"string"==typeof t&&(t=e(t)),this.str+=" - "+t,this},n.prototype.mul=function(t){return"string"==typeof t&&(t=e(t)),this.str+=" * "+t,this},n.prototype.div=function(t){return"string"==typeof t&&(t=e(t)),this.str+=" / "+t,this},n.count=0,n}();t.Var=f;var d=function(t){function e(e){t.call(this,r.bool),this.str=e.toString()}return __extends(e,t),e}(f);t.Bool=d,function(t){t[t.uniform=0]="uniform",t[t.varying=1]="varying",t[t.attribute=2]="attribute"}(t.externalType||(t.externalType={}));var v=t.externalType,m=function(t){function e(e,r,n){t.call(this,e),this.externalType=r,this.name=n||v[r].charAt(0)+"_"+this.name}return __extends(e,t),e.prototype.declare=function(t){this.declared=!0,this.block=t;var e=v[this.externalType]+" "+this.type+" "+this.name;e+=""===this.str?";":" = "+this.str,this.lineNb=this.block.top(e)},e.prototype.link=function(t){switch(this.externalType){case v.uniform:this.location=t.gl.getUniformLocation(t.webglProgram,this.name);break;case v.attribute:this.location=t.gl.getAttribLocation(t.webglProgram,this.name)}if(void 0===this.definition||this.externalType===v.varying)return this.location;var e=v[this.externalType];"float"===this.type?e+="1f":"vec"===this.type.substring(0,3)?e+=this.type.charAt(3)+"f":"mat"===this.type.substr(0,3)?e+="Matrix"+this.type.charAt(3)+"fv":console.warn("Type not supported : "+this.type);var r=this.definition;return r.unshift(this.location),t.gl[e].apply(t.gl,r),this.location},e.prototype.toString=function(){return this.name},e.prototype.val=function(e){t.prototype.val.call(this),";"!==e.charAt(e.length-1)&&(e+=";"),this.str=e,this.block.header[this.lineNb]=(this.isConst?"const ":"")+v[this.externalType]+" "+r[this.type]+" "+this.name+" = "+this.str},e.prototype.define=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.definition=t},e}(f),y=function(t){function e(e,r){t.call(this,e,v.uniform,r)}return __extends(e,t),e}(m);t.Uniform=y;var x=function(t){function e(e,r){t.call(this,e,v.attribute,r)}return __extends(e,t),e}(m);t.Attribute=x;var T=function(t){function e(e,r){t.call(this,e,v.varying,r)}return __extends(e,t),e}(m);t.Varying=T;var _=function(e){function n(i,o){e.call(this,r["float"]),o&&0!==o.length||t.throwError("Size Exception: Int8Array shall not be empty"),this.name="array_"+n.arrayCount++,this.size=Math.floor(o.length),this.values=o,this.shader=i;for(var a=Math.ceil(this.size/2),h=new Uint32Array(4*a),l=0;l<2*o.length;l+=2){var c=o[l/2];h[l]=Math.abs(c),h[l+1]=c>=0?255:0}this.data=s(h,a,1),console.log(h),i.addExternal(this)}return __extends(n,e),n.prototype.declare=function(){var t=this.type;this.type="sampler2D",e.prototype.declare.call(this,this.shader),this.type=t,this.shader.addFunction(H.Int8ArrayAt())},n.prototype.link=function(t){var e=t.gl.createTexture();return t.gl.bindTexture(t.gl.TEXTURE_2D,e),t.gl.texImage2D(t.gl.TEXTURE_2D,0,t.gl.RGBA,t.gl.RGBA,t.gl.UNSIGNED_BYTE,this.data),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MIN_FILTER,t.gl.LINEAR),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_S,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_WRAP_T,t.gl.CLAMP_TO_EDGE),t.gl.texParameteri(t.gl.TEXTURE_2D,t.gl.TEXTURE_MAG_FILTER,t.gl.NEAREST),t.gl.bindTexture(t.gl.TEXTURE_2D,null),this.location=t.gl.getUniformLocation(t.webglProgram,this.name),t.gl.activeTexture(t.gl.TEXTURE0),t.gl.bindTexture(t.gl.TEXTURE_2D,e),t.gl.uniform1i(this.location,0),this.location},n.prototype.at=function(t){var e="string"==typeof t?t:Math.floor(t);return new R("at("+this.toString()+", "+e+", "+U(this.size)+")")},n.arrayCount=0,n}(y);t.Int8Array=_;var w=function(e){function r(r,n){e.call(this,r),0===n.length&&t.throwError("Size Exception: a vector cannot be empty"),this.values=n}return __extends(r,e),r}(f);t.Matrix=w;var E=function(n){function i(s,o){n.call(this,s),0===o.length&&t.throwError("Size Exception: a vector cannot be empty"),this.size=parseInt(r[s].charAt(3)),isNaN(this.size)&&(this.size=1),o.length>this.size&&t.throwError("Size Exception: "+this.size+" floats expected, got "+o.length),this.pre=1===this.size?"float":"vec"+this.size,1===o.length&&"string"==typeof o[0]&&(this.str=this.pre+"("+o[0]+")"),this.str=this.pre+"("+e(o)+")",this.values=o,i.count++}return __extends(i,n),i.prototype.val=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];n.prototype.val.call(this),this.str=this.pre+"("+e(t)+");",this.block.header[this.lineNb]=(this.isConst?"const ":"")+this.pre+" "+this.name+" = "+this.str},i.prototype.at=function(t){var e="string"==typeof t?t:U(t);return new R(this.name+"["+e+"]")},i.count=0,i}(f);t.Vector=E;var b=function(t){function e(e,n){t.call(this,r["vec"+((n?n:0)+2)],e),this.y=e[1]}return __extends(e,t),e}(E);t.Vec2=b;var C=function(t){function e(e,r){t.call(this,e,1+(void 0!==r&&r?1:0)),this.z=e[2]}return __extends(e,t),e.prototype.toVec2=function(){return new b(this.values.splice(0,2))},e}(b);t.Vec3=C;var A=function(t){function e(e){t.call(this,e,!0),this.w=e[3]}return __extends(e,t),e.prototype.toVec3=function(){return new C(this.values.splice(0,3))},e}(C);t.Vec4=A;var R=function(t){function e(e){t.call(this,r["float"],[e])}return __extends(e,t),e}(E);t.Float=R;var S=function(t){function n(){for(var i=[],s=0;s<arguments.length;s++)i[s-0]=arguments[s];t.call(this,r.mat2),this.order=2,this.values=i,this.str="mat2("+e(i)+")",n.count++}return __extends(n,t),n.prototype.val=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];t.prototype.val.call(this),this.block.header[this.lineNb]=(this.isConst?"const ":"")+"mat2 "+this.name+" = mat2("+e(r)+");"},n.prototype.at=function(t){return new R(this.name+"["+t+"][NaN")},n.count=0,n}(f);t.mat2=S;var D=function(t){function n(){for(var i=[],s=0;s<arguments.length;s++)i[s-0]=arguments[s];t.call(this,r.mat3),this.order=3,this.values=i,this.str="mat3("+e(i)+")",n.count++}return __extends(n,t),n.prototype.val=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];t.prototype.val.call(this),this.block.header[this.lineNb]=(this.isConst?"const ":"")+"mat3 "+this.name+" = mat3("+e(r)+");"},n.count=0,n}(f);t.mat3=D;var P=function(t){function n(){for(var i=[],s=0;s<arguments.length;s++)i[s-0]=arguments[s];t.call(this,r.mat4),this.values=i,this.str="mat4("+e(i)+")",n.count++}return __extends(n,t),n.prototype.val=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];t.prototype.val.call(this),this.block.header[this.lineNb]=(this.isConst?"const ":"")+"mat4 "+this.name+" = mat4("+e(r)+");"},n.count=0,n}(f);t.mat4=P;var N,U=function(t){return t instanceof R?t.toString():e(t)},k=function(t){var e;return e=t?"string"==typeof t?document.querySelector(t):t:document.createElement("canvas")},I=function(t,e){return"number"==typeof t?e[t]:t?t:e[0]},L=function(){var t=new h("at",r["int"],"sampler2D array, int index, float length");return t.append("float idx = 2.0 * mod(float(index), length);vec4 v = texture2D(array, vec2(0.5 * idx / length, 0.0));if(mod(idx, 4.0) == 0.0){return int(v.r * sign(v.g - 0.5) * 255.0);}else{return int(v.b * sign(v.a - 0.5) * 255.0);}"),t.precedence=2,t},z=function(t){var e=Math.floor(Math.sqrt(t.size)/2),n=new h("convolution_"+Math.sqrt(t.size),r.vec4,"sampler2D tex, sampler2D kernel");return n.append("vec4 sum = vec4(0.0)","int n = 0","for(int i = "+-e+"; i <= "+e+"; i++){","for(int j = "+-e+"; j <= "+e+"; j++){","sum += texture2D(tex, v_texCoord + u_delta * vec2(j, i)) * float(at(kernel, n, "+U(t.size)+")) / 255.0","n++","}","}","return texture2D(u_image_0, vec2(0.0))"),n.precedence=1,n},F=0,M=function(t){var e=Math.sqrt(t.length),n=Math.floor(e/2),i=new h("convolution_"+F++,r.vec4,"sampler2D tex");i.append("vec4 sum = vec4(0.0)");for(var s=t.length-1,o=-n;n>=o;o++)for(var a=-n;n>=a;a++)i.append("sum += texture2D(tex, v_texCoord + u_delta * vec2("+a+", "+o+")) * "+U(t[s--]));return i.append("return sum;"),i.precedence=1,i},B=function(){var t=new h("grey",r["float"],"vec3 color");return t.append("return dot(color, vec3(0.2126, 0.7152, 0.0722))"),t};!function(t){t[t.BINARY=0]="BINARY",t[t.BINARY_INV=1]="BINARY_INV",t[t.TRUNC=2]="TRUNC",t[t.TO_ZERO=3]="TO_ZERO",t[t.TO_ZERO_INV=4]="TO_ZERO_INV"}(N||(N={}));var X,G=function(t){t||(t=N.BINARY);var e=new h("thresh_"+N[t].toLowerCase(),r.vec3,"vec3 color, float thresh, float max");switch(t){case N.BINARY:e.append("return step(thresh, color) * vec3(max)");break;case N.BINARY_INV:e.append("return vec3(max) - step(thresh, color)");break;case N.TRUNC:e.append("vec3 s = step(thresh, color) * thresh"),e.append("return step(color, vec3(1.0) - s)")}return e};!function(t){t[t.ABS=1]="ABS",t[t.SQRT=2]="SQRT"}(X||(X={}));var O=function(){var t=new h("sobel",r["float"],"sampler2D tex, int method"),e=[-1,-2,-1,0,0,0,1,2,1],n=[-1,0,1,-2,0,2,-1,0,1],i=H.convolution(e),s=H.convolution(n);return t.append("float Gx = length("+i.name+"(tex));float Gy = length("+s.name+"(tex));if(method == 1){return abs(Gx) + abs(Gy);}else{return sqrt(pow(Gx, 2.0) + pow(Gy, 2.0));}"),[t,i,s]},V=function(){var t=new h("posterize",r.vec3,"vec3 color, float gamma, float numColors");return t.append("color = pow(color, vec3(gamma));color *= numColors;color = floor(color);color /= numColors;return pow(color, vec3(1.0 / gamma));"),t},q=function(){var t=new h("pixelate",r.vec4,"sampler2D tex, float size");return t.append("return texture2D(tex, size * u_delta * floor(v_texCoord / d))"),t},Y=function(){var t=new h("negative",r.vec3,"vec3 color");return t.append("return "+float(1).sub("color")),t},j=function(){function e(t,e,n){if(this.textures=[],this.loadedCount=0,this.onTexturesLoadedCallbacks=[],this.texturesLoaded=!1,this.onRenderedCallbacks=[],this.rendering=!1,this.canvas=k(t),n)this.vs=n.vertex,this.fs=n.fragment;else{this.fs=new p,this.fs.setPrecision(r["float"],u.mediump);var i=new y(r.vec2,"u_delta");i.define(1/this.canvas.width,1/this.canvas.height),this.fs.addExternal(i),this.vs=new c}if(this.fragColor=this.fs.fragColor,this.position=this.vs.position,e&&e instanceof Array)for(var s=0;s<e.length;s++){var a=e[s];this.addTexture(a)}else e instanceof o&&this.addTexture(e)}return e.prototype.addTexture=function(t){for(var e=0,r=this.textures;e<r.length;e++){var n=r[e];if(n.name===t.name)return!1}return this.textures.push(t),t.onload(this.textureLoaded,this),!0},e.prototype.textureLoaded=function(){if(this.loadedCount++,this.loadedCount===this.textures.length){this.texturesLoaded=!0;for(var t=0,e=this.onTexturesLoadedCallbacks;t<e.length;t++){var r=e[t];r.callback.call(r.thisArg)}this.onTexturesLoadedCallbacks=[]}},e.prototype.toImage=function(){var t=this;return this.rendering||this.render(),new Promise(function(e,r){t.onRendered(function(){var t=new Image;t.src=this.canvas.toDataURL(),e(t)},t)})},e.prototype.find_contours=function(t,e){this.readPixels(function(r){for(var n=r.length,i=new Uint16Array(r.length/4),s=0,o=0;n>o;o+=4)255===r[o]&&(i[s++]=o/4);i=i.subarray(0,s+1),t.call(e||this,i)},this)},e.prototype.readPixels=function(t,e){this.rendering||this.render(),this.onRendered(function(){var r=new Uint8Array(this.canvas.width*this.canvas.height*4),n=this.program.gl;n.readPixels(0,0,this.canvas.width,this.canvas.height,n.RGBA,n.UNSIGNED_BYTE,r),t.call(e||this,r)})},e.prototype.sobel=function(t,e){var r=this;e||(e=X.SQRT);var n=I(t,this.textures);this.addTexture(n),this.onTexturesLoaded(function(){r.fs.addFunctions(H.sobel())},this);var i=new R("sobel("+n+", "+e+")");return i.declare(this.fs.main),i},e.prototype.grey=function(t){this.fs.addFunction(H.grey());var e=new R("grey("+(t||this.fs.fragColor)+".rgb)");return e.declare(this.fs.main),e},e.prototype.posterize=function(t,e,r){e=e||.6,r=r||8,r-=r%1,this.fs.addFunction(H.posterize());var n=new C(["posterize("+(t||this.fs.fragColor)+".rgb, "+U(e)+", "+U(r)+")"]);return n.declare(this.fs.main),n},e.prototype.pixelate=function(t,e){var r=I(t,this.textures);e=e||5,this.fs.addFunction(H.pixelate());var n=new A(["pixelate("+r+", "+U(e)+")"]);return n.declare(this.fs.main),n},e.prototype.convolution=function(e,r){var n=Math.sqrt(r.length);n%1!==0&&t.throwError("Kernel sould be a square matrix (length = perfect square nb)"),(n%2!==1||1===n)&&t.throwError("Kernel should have an odd number of rows and cols > 1");var i=I(e,this.textures),s=H.convolution(r);this.onTexturesLoaded(function(){this.fs.addFunction(s)},this);var o=new A([s.name+"("+i+")"]);return o.declare(this.fs.main),o},e.prototype.threshold=function(t,e,r,n){r=r||1,n=n||N.BINARY;var i="thresh_"+N[n].toLowerCase();if(!this.fs.hasFunc(i)){var s=H.threshold(n);this.fs.addChild(s)}var o=new C([i+"("+t+".rgb, "+U(e)+", "+U(r)+")"]);return o.declare(this.fs.main),o},e.prototype.setSize=function(t,e){this.canvas.width=t,this.canvas.height=e},e.prototype.onTexturesLoaded=function(t,e){this.texturesLoaded||0===this.textures.length?t.call(e||this):this.onTexturesLoadedCallbacks.push({callback:t,thisArg:e})},e.prototype.onRendered=function(t,e){this.program?t.call(e||this):this.onRenderedCallbacks.push({callback:t,thisArg:e})},e.prototype.width=function(){return this.canvas.width},e.prototype.height=function(){return this.canvas.height},e.prototype.render=function(){this.program||this.rendering||(this.rendering=!0,this.onTexturesLoaded(function(){this.program=new g(this.canvas,{vertex:this.vs,fragment:this.fs});for(var t=0,e=this.textures;t<e.length;t++){var r=e[t];this.program.addTexture(r)}var n=(new Date).getTime();this.program.compile(),this.program.render(),this.rendering=!1,console.log((new Date).getTime()-n+"ms");for(var i=0,s=this.onRenderedCallbacks;i<s.length;i++){var o=s[i];o.callback.call(o.thisArg)}this.onRenderedCallbacks=[]},this))},e.prototype.destroy=function(){this.fs.destroy(this.program.gl),this.vs.destroy(this.program.gl),this.program.gl.deleteProgram(this.program.webglProgram),this.program.webglProgram=null,this.program=void 0},e}();t.Context=j;var W,H={convolution:M,convolution2:z,grey:B,threshold:G,sobel:O,posterize:V,pixelate:q,Int8ArrayAt:L,negative:Y};!function(t){t.vec_mul=function(t,e){var r=t.length,n=[];if("number"==typeof e){for(var i=0;r>i;i++)n.push(t[i]*e);return n}for(var i=0;r>i;i++)n.push(t[i]*e[i]);return n},t.vec_div=function(t,e){var r=t.length,n=[];if("number"==typeof e){for(var i=0;r>i;i++)n.push(t[i]/e);return n}for(var i=0;r>i;i++)n.push(t[i]/e[i]);return n},t.conv_mult=function(e,r){for(var n=[],i=0;i<e.length;i++){var s=e[i];n.push(t.vec_mul(e,s))}return n};var e=function(t){for(var e=0,r=0;r<t.length;r++){var n=t[r];e+=n}e/=t.length;for(var i=0,s=0;s<t.length;s++){var n=t[s];i+=Math.abs(n-e)}return{avg:e,std:i}},r=function(){function r(t){if(this.rows=[],this.cols=[],Array.isArray(t)){for(var e=t[0].length,r=0,n=0;n<t.length;n++){var i=t[n];this.rows.push(i);for(var s=0;e>s;s++)this.cols[s]||(this.cols[s]=[]),this.cols[s][r]=i[s];r++}this.squared=this.rows.length===this.cols.length,this.length=this.rows.length*this.cols.length}else this.separation=t,this.squared=t.vertical.length===t.horizontal.length,this.length=t.vertical.length*t.horizontal.length}return r.prototype.isSeparable=function(r){void 0===r&&(r=.01);for(var n=0,i=this.rows;n<i.length;n++)for(var s=i[n],o=0;o<this.rows.length;o++)if(e(t.vec_div(s,this.rows[o])).std>r)return!1;return!0},r.prototype.separate=function(r){if(void 0===r&&(r=.01),!this.isSeparable(r))return null;for(var n=this.rows[0],i=[1],s=1;s<this.rows.length;s++){var o=e(t.vec_div(n,this.rows[s])).avg;i.push(isFinite(o)?o:0)}return{vertical:i,horizontal:n}},r}();t.ConvolutionKernel=r}(W=t.math||(t.math={}))}(wcv||(wcv={}));